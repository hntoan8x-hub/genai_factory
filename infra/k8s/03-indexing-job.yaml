# Tri·ªÉn khai Indexing (MLOps Job)
# ----------------------------------------------------
# üîπ JOB: RAG Indexing (Role: TRAINER)
# ----------------------------------------------------
apiVersion: batch/v1
kind: Job
metadata:
  name: rag-indexing-onetime-$(date +%s) # T√™n Job ƒë·ªôc nh·∫•t theo th·ªùi gian
spec:
  template:
    spec:
      restartPolicy: OnFailure # N·∫øu Job th·∫•t b·∫°i, K8s s·∫Ω th·ª≠ l·∫°i
      containers:
        - name: rag-indexer
          # S·ª≠ d·ª•ng Image t·ª´ trainer.Dockerfile
          image: your-registry/genai-factory:trainer-v1.0

          # HARDENING: Resource Limits (Indexing l√† CPU/I/O n·∫∑ng)
          resources:
            limits:
              cpu: "4000m" # 4 cores
              memory: "8Gi"
            requests:
              cpu: "1000m"
              memory: "4Gi"

          envFrom:
            - secretRef:
                name: genai-factory-secrets
            - configMapRef:
                name: genai-factory-configs

          # ENTRYPOINT: Override ƒë·ªÉ ch·∫°y script Indexing
          # Chuy·ªÉn c√°c tham s·ªë c·∫•u h√¨nh qua args (theo parse_args trong run_rag_indexing.py)
          args:
            [
              "--ingestion-config-path",
              "$(INGESTION_CONFIG_PATH)",
              "--feature-store-config-path",
              "$(FEATURE_STORE_CONFIG_PATH)",
            ]

          # L·ªánh ch·∫°y ch√≠nh l√† ENTRYPOINT ["python3", "scripts/run_rag_indexing.py"]
