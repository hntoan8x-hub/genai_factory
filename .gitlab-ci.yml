variables:
  # Base registry n∆°i c√°c image ƒë√£ ƒë∆∞·ª£c Hardening ƒë∆∞·ª£c l∆∞u tr·ªØ
  REGISTRY_BASE: your-internal-registry/genai-factory
  # Phi√™n b·∫£n m·ªõi s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai, g·∫Øn v·ªõi Git Commit SHA
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  # Phi√™n b·∫£n Inference Image ho√†n ch·ªânh (s·∫Ω ƒë∆∞·ª£c deploy)
  INFERENCE_IMAGE: $REGISTRY_BASE:inference-$IMAGE_TAG
  # Endpoint c·∫ßn ki·ªÉm th·ª≠ (Gi·∫£ ƒë·ªãnh K8s LoadBalancer IP/DNS)
  ENDPOINT_URL: http://genai-assistant-service.production.internal
# Stage 1: Build & Package (CI)
stages:
  - build
  - test
  - deploy
  - validate
  - rollout

# ----------------------------------------------------
# üîπ Stage 1: BUILD
# Tr√°ch nhi·ªám: Build Docker Images (Trainer, Inference, ETL)
# ----------------------------------------------------
build_images:
  stage: build
  image: docker:20.10.16 # D√πng image Docker ƒë·ªÉ ch·∫°y l·ªánh Docker
  services:
    - docker:20.10.16-dind
  script:
    - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token $REGISTRY_BASE --password-stdin

    # Build Image BASE (Stage 1 & 2) - C·∫ßn ch·∫°y ƒë·∫ßu ti√™n
    - docker build -f Dockerfile.base -t $REGISTRY_BASE:hardened-base .

    # Build Image INFERENCE (S·∫Ω ƒë∆∞·ª£c tri·ªÉn khai Real-time)
    - docker build -f inference.Dockerfile -t $INFERENCE_IMAGE .

    # Build Image TRAINER (Cho Indexing/Finetuning)
    - docker build -f trainer.Dockerfile -t $REGISTRY_BASE:trainer-$IMAGE_TAG .

    # ƒê·∫©y t·∫•t c·∫£ c√°c Images l√™n Registry n·ªôi b·ªô
    - docker push $INFERENCE_IMAGE
    - docker push $REGISTRY_BASE:trainer-$IMAGE_TAG

  tags:
    - docker-build-runner # S·ª≠ d·ª•ng runner c√≥ quy·ªÅn build v√† push Docker
# ----------------------------------------------------
# üîπ Stage 2: TEST
# Tr√°ch nhi·ªám: Ch·∫°y Unit Tests, Pydantic Schema Validation Tests
# ----------------------------------------------------
unit_tests:
  stage: test
  image: $REGISTRY_BASE:hardened-base # D√πng image base ƒë·ªÉ ch·∫°y code ƒë√£ copy
  script:
    - python3 -m pytest tests/unit/ # Ch·∫°y Unit Tests
    - python3 scripts/check_config_consistency.py # Ki·ªÉm tra t√≠nh nh·∫•t qu√°n (v√≠ d·ª•: Vector Dim)
# ----------------------------------------------------
# üîπ Stage 3: DEPLOY
# Tr√°ch nhi·ªám: Tri·ªÉn khai Image m·ªõi l√™n K8s (ch∆∞a chuy·ªÉn traffic)
# ----------------------------------------------------
deploy_new_version:
  stage: deploy
  image: $REGISTRY_BASE:experimentation-v1.0 # D√πng EXPERIMENTATION Role
  script:
    - echo "Tri·ªÉn khai K8s Deployment file..."
    # 1. Ch·∫°y script deploy_service.py (s·∫Ω s·ª≠ d·ª•ng K8s API b√™n d∆∞·ªõi)
    - python3 scripts/deploy_service.py \
      --model-name "genai-assistant" \
      --artifact-uri "mlflow:///assistant-$IMAGE_TAG" \
      --image-uri $INFERENCE_IMAGE

    - echo "ƒê√£ tri·ªÉn khai $IMAGE_TAG th√†nh c√¥ng (0% traffic)."
  # Ch·ªâ ch·∫°y khi Stage TEST th√†nh c√¥ng
  needs:
    - unit_tests
  environment:
    name: production

# ----------------------------------------------------
# üîπ Stage 4: VALIDATE (Load Test - Ki·ªÉm tra SLA)
# Tr√°ch nhi·ªám: Ki·ªÉm tra ƒë·ªô tr·ªÖ (Latency) v√† t·ª∑ l·ªá l·ªói (Error Rate)
# ----------------------------------------------------
run_performance_test:
  stage: validate
  image: $REGISTRY_BASE:experimentation-v1.0
  script:
    - echo "B·∫Øt ƒë·∫ßu ki·ªÉm tra Load Test (SLA Check)..."
    # Ch·∫°y run_load_test.py (ki·ªÉm tra P95 Latency)
    - python3 scripts/run_load_test.py \
      --endpoint-url $ENDPOINT_URL \
      --model-version $IMAGE_TAG

    - echo "Load Test ho√†n t·∫•t. B·∫Øt ƒë·∫ßu Canary Rollout."
  # Ch·ªâ ch·∫°y khi Stage DEPLOY th√†nh c√¥ng
  needs:
    - deploy_new_version
  environment:
    name: production

# ----------------------------------------------------
# üîπ Stage 5: ROLLOUT (Canary & Auto-Rollback)
# Tr√°ch nhi·ªám: Chuy·ªÉn traffic v√† t·ª± ƒë·ªông Rollback n·∫øu check_live_metrics th·∫•t b·∫°i
# ----------------------------------------------------
run_canary_rollout:
  stage: rollout
  image: $REGISTRY_BASE:experimentation-v1.0
  script:
    # Ch·∫°y script ƒëi·ªÅu ph·ªëi Canary Rollout (S·∫Ω g·ªçi Rollback n·∫øu c·∫ßn)
    - python3 scripts/run_canary_rollout.py \
      --endpoint-name "genai-assistant-service" \
      --new-version $IMAGE_TAG \
      --stable-version $STABLE_MODEL_VERSION # Phi√™n b·∫£n ·ªïn ƒë·ªãnh ƒë√£ bi·∫øt

  # Lu√¥n cho ph√©p ch·∫°y (d√π Stage tr∆∞·ªõc ƒë√≥ c√≥ th·ªÉ c√≥ l·ªói logic)
  needs:
    - run_performance_test
  environment:
    name: production
